# gmod-tracy

[![C++ Standard](https://img.shields.io/badge/C%2B%2B-26-00599C?style=for-the-badge&logo=cplusplus&logoColor=white&labelColor=1C1C1C)](https://isocpp.org/)
[![CMake](https://img.shields.io/badge/CMake-3.30%2B-064F8C?style=for-the-badge&logo=cmake&logoColor=white&labelColor=1C1C1C)](https://cmake.org)
[![License](https://img.shields.io/badge/License-AGPL--3.0-FF6B6B?style=for-the-badge&logo=gnu&logoColor=white&labelColor=1C1C1C)](https://www.gnu.org/licenses/agpl-3.0.html)

A Garry's Mod binary module that exposes [Tracy Profiler](https://github.com/wolfpld/tracy) to GLua. Instrument your server/client Lua code with named zones, frame marks, plots, and messages — captured live in Tracy's GUI over TCP.

## How It Works

The module compiles to a shared library loaded by GMod's binary module system. `tracy_loader.lua` (auto-generated by CMake, placed in `autorun/server`) calls `require("gmod_tracy")`, which registers a `tracy` global table and returns it. Tracy communicates with its desktop GUI via TCP — all emit calls are near-zero cost when no client is connected.

```
GLua script
  └─ require("gmod_tracy")        -- binary module, loaded from lua/bin/
       └─ tracy.ZoneBeginN(...)   -- Tracy C API emit
            └─ Tracy GUI  <──TCP──  tracy profiler client (desktop)
```

## Prerequisites

- `cmake 3.30+`
- `ninja`
- C++26 compiler: `clang++` / `g++` (Linux), MSVC 2022 (Windows)
- [Tracy GUI](https://github.com/wolfpld/tracy/releases) — to capture and visualize profiling data
- Garry's Mod installation (for `GMOD_LUA_DIR`)

## Build

### Configure & Build

Pick a preset:

| preset | toolchain | target |
|---|---|---|
| `clang` | clang/clang++ | Linux (native) |
| `gcc` | gcc/g++ | Linux (native) |
| `msvc` | MSVC 2022 | Windows (native) |
| `llvm-mingw-i686` | llvm-mingw | Windows 32-bit (cross from Linux) |
| `llvm-mingw-x86_64` | llvm-mingw | Windows 64-bit (cross from Linux) |

```bash
cmake --preset=clang -DGMOD_LUA_DIR=/path/to/garrysmod/lua .
cmake --build --preset=clang
```

> `GMOD_LUA_DIR` defaults to a hardcoded path — always override it.

### Dev Workflow (Linux)

```bash
# build + symlink .so and tracy_loader.lua into GMod dirs
cmake --build build/clang --target symlink_gmod

# build + symlink + launch GMod via Steam
cmake --build build/clang --target launch_gmod
```

`symlink_gmod` creates symlinks (not copies):

- `$GMOD_LUA_DIR/bin/<module>.so` → build output
- `$GMOD_LUA_DIR/autorun/server/tracy_loader.lua` → `build/clang/src/tracy_loader.lua`

`launch_gmod` runs:

```bash
GLIBC_TUNABLES=glibc.rtld.optional_static_tls=1024 \
  steam -applaunch 4000 -console +map gm_flatgrass -noworkshop -noreplay
```

> The `GLIBC_TUNABLES` env var is required on Linux for binary modules that use thread-local storage (Tracy uses TLS internally).

### Install (Production)

```bash
cmake --install build/clang --config Release
```

Installs `.so` → `$GMOD_LUA_DIR/bin/`, `tracy_loader.lua` → `$GMOD_LUA_DIR/autorun/server/`.

## GLua API

The module registers `_G.tracy` and also returns the table from `require`:

```lua
local tracy = require("gmod_tracy")
-- or just use the global: tracy.ZoneBeginN(...)
```

### Zones

Zones are the primary instrumentation primitive. `ZoneBeginN` returns an opaque integer handle — pass it to all subsequent zone calls. Call `ZoneEnd` exactly once per handle.

```lua
local h = tracy.ZoneBeginN("think_hook")
tracy.ZoneColor(h, 255, 128, 0)
tracy.ZoneText(h, "ents=" .. tostring(#ents))
-- ... your code ...
tracy.ZoneEnd(h)
```

| function | signature | description |
|---|---|---|
| `ZoneBeginN` | `(name: string) -> handle` | begin a named zone |
| `ZoneEnd` | `(handle)` | end zone, release handle |
| `ZoneText` | `(handle, text: string)` | attach free-form text |
| `ZoneName` | `(handle, name: string)` | override zone name at runtime |
| `ZoneColor` | `(handle, r, g, b: 0–255)` | set zone color in Tracy GUI |
| `ZoneValue` | `(handle, val: number)` | attach a numeric value |

### Frame Marks

```lua
tracy.FrameMark()                  -- mark end of a logical frame
tracy.FrameMarkNamed("tick")       -- independent named frame counter

tracy.FrameMarkStart("render")
-- ...
tracy.FrameMarkEnd("render")       -- bracketed named interval
```

### Messages & Plots

```lua
tracy.Message("map loaded")
tracy.MessageColor("lua error caught", 255, 64, 64)

tracy.PlotValue("entity_count", #ents)   -- shows as continuous graph in Tracy
tracy.AppInfo("gmod dedicated v" .. VERSION)

if tracy.IsConnected() then  -- bool: Tracy GUI is connected
    -- hot-path instrumentation guard
end
```

## CMake Cache Variables

| variable | default | description |
|---|---|---|
| `GMOD_LUA_DIR` | hardcoded path | path to `garrysmod/lua` |
| `GMOD_MODULE_NAME` | `gmod_tracy` | name passed to `require()` in loader |
| `gmod_tracy_realm` | `gmcl` | module realm prefix (`gmsv` / `gmcl`) |

## Dependencies

Fetched automatically via [CPM](https://github.com/cpm-cmake/CPM.cmake) — no manual setup:

| dependency | source | purpose |
|---|---|---|
| `gmod-module-base` | `Facepunch/gmod-module-base@development` | GMod binary module ABI |
| `Tracy::TracyClient` | `wolfpld/tracy` | profiler client (`TRACY_ENABLE` always set) |
| `spdlog` | `gabime/spdlog` | logging |
| `Microsoft.GSL::GSL` | `microsoft/GSL` | `gsl::not_null`, `gsl::narrow_cast` |

## Roadmap

- [ ] develop

## References

- **[Tracy Profiler](https://github.com/wolfpld/tracy)** — docs, GUI releases, protocol spec, manual
- **[gmod-module-base](https://github.com/Facepunch/gmod-module-base)** — Facepunch binary module ABI
- **[Garry's Mod Wiki](https://wiki.facepunch.com/gmod/)** — GLua reference, binary module docs
- **[Performance-Aware Programming](https://www.computerenhance.com/)** by Casey Muratori — why profiling matters
- **[cppreference C++26](https://en.cppreference.com/w/cpp/26)** — language reference
- **[Compiler Explorer](https://godbolt.org/)** — inspect generated output
